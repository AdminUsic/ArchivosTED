<div class="container-fluid">
    <!-- /.card -->
    <!-- Horizontal Form -->
    <div class="card card-info">
        <div class="card-header">
            <h2 class="m-0 font-weight-bold card-title"
                th:text="${edit}? 'Modificar Registro de Archivo' : 'Registrar Archivo'"></h2>
        </div>
        <!-- /.card-header -->
        <!-- form start -->

        <form class="form-horizontal" id="FormularioRegistrarArchiList" method="POST"
            th:action="${edit} ? @{/ModArchivoG} : @{/GuardarRegistroArchivo}" enctype="multipart/form-data">
            <div class="card-body">
                <div th:if="${edit == 'true'}">
                    <input type="hidden" th:field="${archivo.id_archivo}" />
                </div>
                <input type="hidden" th:each="carpeta : ${carp}" th:value="${carpeta}" id="id_carpeta"
                    name="id_carpeta" />
                <div class="row">
                    <div class="col-sm-6">
                        <label>Nro. de Fojas</label>
                        <div class="form-group form-outline">
                            <input type="number" th:field="${archivo.cantidadHojas}" class="form-control"
                                placeholder="Introdusca el nro. de fojas del documento" min="1" required />
                            <label class="form-label">Nro. de Fojas:</label>
                        </div>
                        <label>Nombre del Documento</label>
                        <div class="form-group form-outline">
                            <input type="text" th:field="${archivo.nombre}" class="form-control"
                                placeholder="Introdusca un nombre/titulo" required />
                            <label class="form-label">Nombre:</label>
                        </div>
                        <label>Gestion</label>
                        <div class="form-group form-outline">
                            <input type="number" th:field="${archivo.gestion}" class="form-control"
                                placeholder="Introdusca una nota si es necesario">
                            <label class="form-label">Gestion:</label>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label>Serie Documental</label>
                            <select class="select-fieldArchivoCarpetaModalList" style="width: 100%;"
                                th:field="${archivo.serieDocumental}" id="selectUnidadCModalList">
                                <option th:value="${edit} ? ${archivo.serieDocumental.id_serie} : ''"
                                    th:text="${edit} ? ${archivo.serieDocumental.nombre} : 'Seleccionar'" selected>
                                </option>
                                <option th:each="serieDoc: ${seriesDocumental}" th:text="${serieDoc.nombre}"
                                    th:value="${serieDoc.id_serie}"></option>
                            </select>
                        </div>
                        <label>Notas</label>
                        <div class="form-group form-outline">
                            <textarea type="text" th:field="${archivo.nota}" class="form-control"
                                placeholder="Introdusca una nota si es necesario"></textarea>
                            <label class="form-label">Notas:</label>
                        </div>
                        <th:block th:if="${userLog.persona.cargo.nombre == 'ARCHIVO Y BIBLIOTECA'}">
                            <label>Ubicación Fisica</label>
                            <div class="form-group form-outline"
                                th:if="${userLog.persona.cargo.nombre == 'ARCHIVO Y BIBLIOTECA'}">
                                <input type="text" th:field="${archivo.rutaFisica}" class="form-control"
                                    placeholder="Introdusca una ruta fisica del Archivo" required />
                                <label class="form-label">Ubicacion Fisica del Documento</label>
                            </div>
                        </th:block>
                        <div class="form-group">
                            <label for="tipoArchivo">Cubierta</label>
                            <select class="select-fieldArchivoCarpetaModalList" style="width: 100%;" th:field="${archivo.cubierta}"
                                id="selectSeccionDACList">
                                <option th:value="${edit} ? ${archivo.cubierta.id_cubierta} : ''"
                                    th:text="${edit} ? ${archivo.cubierta.nombre} : 'Seleccionar'" selected></option>
                                <option th:each="cubierta: ${cubiertas}" th:text="${cubierta.nombre}"
                                    th:value="${cubierta.id_cubierta}"></option>
                            </select>
                        </div>
                    </div>
                    <div th:class="${edit}? 'col-sm-6' : ''">
                        <div class="form-group">
                            <label class="form-label">Adjuntar Documento</label>
                            <input type="file" name="PDF" id="PDFformularioModalCList" accept=".pdf">
                            <div id="alertasFormArchivoModalCList"></div>
                        </div>
                    </div>
                    <div th:class="${edit}? 'col-sm-6' : ''" th:if="${edit == 'true'}">
                        <div class="form-group" th:if="${edit == 'true'}">
                            <div class="filtr-item col-sm-6">
                                <div class="row">
                                    <p class="text-muted m-0">Documento:</p>
                                </div>
                                <div class="image-container">
                                    <a type="button" data-mdb-dismiss="modal" data-mdb-toggle="modal"
                                        data-mdb-target="#archivoModal" th:if="${archivo.contenido != null}"
                                        th:attr="onclick='ContenidoArchivo(\'' + ${archivo.id_archivo} + '\')'">
                                        <img class="icono-image" th:src="@{'/verIcoPdf/' + ${archivo.id_archivo}}"
                                            alt="Imagen 1">
                                    </a>
                                    <div class="alert alert-warning d-flex align-items-center" role="alert"
                                        th:if="${archivo.contenido == null}">
                                        <i class="fa-solid fa-triangle-exclamation me-2" width="24" height="24"></i>

                                        <div>
                                            Este registro no tiene el contenido del documento.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer" style="background-color: white;">
                    <div id="botonesFormulario">
                        <input type="submit" class="btn btn-success"
                            th:value="${edit} ? 'Guardar Cambios' : 'Registrar'">
                    </div>
                    <a type="button" onclick="cancelarModArchivo()" class="btn btn-default float-right">Cancelar</a>
                </div>
        </form>
    </div>
    <!-- /.card -->
    <script>
        $(document).ready(function () {
            $('#FormularioRegistrarArchiList').submit(function (event) {
                event.preventDefault();
                var botonCargando = `<button id="submitButton" class="btn btn-success" disabled>
                                                <span class="spinner-border spinner-border-sm" role="status"
                                                    aria-hidden="true"></span>
                                                <span class="visually-hidden">Loading...</span>
                                                Cargando...
                                            </button>`;
                var botonRegistrar = `<input class="btn btn-success" type="submit" value="Registrar">`;
                var botonModificar = `<input class="btn btn-success" type="submit" value="Modificar">`;
                $('#botonesFormulario').html(botonCargando);
                var form = document.getElementById("FormularioRegistrarArchiList");
                var id_carpeta = document.getElementById("id_carpeta").value;
                var action = form.action;
                var formData = new FormData(form);

                var selectUnidadCModal = document.getElementById("selectUnidadCModalList").value;
                var selectSeccionDAC = document.getElementById("selectSeccionDACList").value;
                //var selectResponsableAC = document.getElementById("selectResponsableAC").value;

                if (selectUnidadCModal != "" && selectSeccionDAC != "") {
                    $.ajax({
                    type: 'POST',
                    url: $(this).attr('action'),
                    data: formData,
                    contentType: false,  // No establecer el tipo de contenido aquí
                    processData: false,  // No procesar los datos
                    //contentType: 'application/x-www-form-urlencoded', // Agregar esta línea
                    success: function (response) {
                        var mensaje = response;
                        cargarTabla();
                        if (response == "Se ha Registrado el Archivo correctamente") {
                            AbrirCarpetaList(id_carpeta);
                            $('#botonesFormulario').html(botonRegistrar);
                            //toastr.success(mensaje);
                            Swal.fire(
                                'Realizado!',
                                mensaje,
                                'success'
                            );
                        } else if (mensaje == "Se ha Modificado el Archivo correctamente") {
                            AbrirCarpetaList(id_carpeta);
                            $('#botonesFormulario').html(botonModificar);
                            //toastr.success(mensaje);
                            Swal.fire(
                                'Realizado!',
                                mensaje,
                                'success'
                            );
                        } else if (mensaje = "ERROR AL REGISTRAR ARCHIVO") {
                            toastr.error(mensaje);

                        } else if (mensaje = "ERROR MODIFICAR EL ARCHIVO") {
                            toastr.error(mensaje);
                        }
                    },
                    error: function (xhr, status, error) {
                        toastr.error('Ha ocurrido un error. Por favor, intenta nuevamente.');
                        console.error(error);
                        // Manejo de errores
                    }
                });
                } else if (selectUnidadCModal == "") {
                    toastr.info('Tiene que seleccionar una Unidad/Seccion para este Registro');
                } else if (selectSeccionDAC == "") {
                    //toastr.info('Tiene que seleccionar una Unidad/Seccion Documental para este Registro');
                    $('#botonesFormulario').html(botonRegistrar);
                    Swal.fire(
                        'Imposible Registrar!',
                        'Tiene que seleccionar una Unidad/Seccion Documental para este Registro',
                        'error'
                    );
                }
            });

        });
        function limpiarFormularioR() {
            var form = document.getElementById("FormularioRegistrarArchiList");
            form.reset();
        }
        function cancelarModArchivo() {
            var id_carpeta = document.getElementById("id_carpeta").value;
            cargarTablaArchivoList(id_carpeta);
        }
    </script>

    <script>
        var fileInput
        var nombreArchivo;
        // Agregamos un evento al input de tipo archivo para que se active cuando se seleccione un archivo
        document.getElementById("PDFformularioModalCList").addEventListener("change", function () {
            // Obtenemos el elemento seleccionado
            fileInput = document.getElementById("PDFformularioModalCList");
            nombreArchivo = fileInput.files[0].name;
            // Verificamos si se seleccionó un archivo
            if (fileInput.files.length > 0) {
                // Obtenemos el nombre del archivo
                var fileName = fileInput.files[0].name;
                // Verificamos si la extensión del archivo es PDF
                if (!isValidPDF(fileName)) {
                    // Reseteamos el valor del input file para borrar la selección inválida
                    fileInput.value = "";
                    $('#alertasFormArchivoModalCList').html('<div class="alert alert-danger alert-dismissible">' +
                        '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
                        '<h6><i class="icon fas fa-ban"></i> El archivo no es Valido!</h6>' +
                        'Solo se Admite Archivos tipo PDF' +
                        '</div>');
                } else {

                    $('#alertasFormArchivoModalCList').html('<div class="alert alert-success alert-dismissible">' +
                        '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
                        '<h6><i class="icon fas fa-check"></i> El archivo ' + nombreArchivo + ' es Valido!</h6>' +
                        '</div>');
                }
            }
        });

        // Función para validar si el nombre del archivo tiene extensión PDF
        function isValidPDF(fileName) {
            var validExtensions = ["pdf"];
            var fileExtension = fileName.split(".").pop().toLowerCase();
            return validExtensions.indexOf(fileExtension) !== -1;
        }

        $(function () {

            $('#PDFformularioModalCList').bs_dropzone({
                maxFiles: 1,
                acceptedFiles: '.pdf',
                boxClass: 'alert p-5 text-center font-weight-bold',
                noneColorClass: 'alert alert-success alert-dismissible',
                dragColorClass: 'alert alert-warning alert-dismissible',
                doneColorClass: 'alert alert-success alert-dismissible',
                failColorClass: 'alert alert-danger alert-dismissible',
                language: {
                    emptyText: 'Introdusca o arrastre un archivo PDF',
                    dragText: '[Soltar aquí]',
                    dropText: 'El archivo se subió correctamente'
                }
            });

        });
    </script>
    <script>
        document.querySelectorAll('.form-outline').forEach((formOutline) => {
            new mdb.Input(formOutline).init();
        });
    </script>
    <script>
        $('.select-fieldArchivoCarpetaModalList').select2({
            theme: 'bootstrap-5'
        });
    </script>

    <script>
        $(function () {
            $('input.datepickerformArchList').datepicker({
                format: "DD/MM/YYYY",
                minDate: "1900-01-01"
            });
        });
    </script>
    <script>
        function AgregarPersonaArchivo() {
            Swal.fire({
                title: 'Agregar Responsable',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Agregar',
                html: '<br><div class="container-fluid">' +
                    '<form class="form-horizontal" id="FormAgregarPersonaArchivo" method="POST" action="/RegistrarPersonaA">' +
                    '<div class="form-group form-outline">' +
                    '<input type="text" name="nombrePerson" id="nombrePerson" class="form-control" placeholder="Introduzca Nombres" required/>' +
                    '<label class="form-label" for="nombre">Nombre</label>' +
                    '</div>' +
                    '<div class="form-group form-outline">' +
                    '<input type="text" name="apellidoPerson" id="apellidoPerson" class="form-control" placeholder="Introduzca Apellidos" required/>' +
                    '<label class="form-label">Apellidos</label>' +
                    '</div>' +
                    '<div class="form-group form-outline">' +
                    '<input type="number" name="ciPerson" class="form-control" placeholder="Introduzca C.I." required/>' +
                    '<label class="form-label">C.I.</label>' +
                    '</div>' +
                    '</form>' +
                    '</div>'
            }).then((result) => {
                if (result.isConfirmed) {
                    var formData = $('#FormAgregarPersonaArchivo').serialize();
                    $.ajax({
                        type: 'POST',
                        url: $('#FormAgregarPersonaArchivo').attr('action'),
                        data: formData,
                        contentType: 'application/x-www-form-urlencoded',
                        success: function (response) {
                            if (response == 'Se realizó el registro correctamente') {
                                $.ajax({
                                    type: 'POST',
                                    url: '/DatoPersona',
                                    data: formData,
                                    contentType: 'application/x-www-form-urlencoded',
                                    success: function (fila) {
                                        var select = document.getElementById('selectResponsableAC');
                                        var option = document.createElement('option');
                                        option.value = fila[0];
                                        option.text = fila[1];
                                        option.selected = true;
                                        select.appendChild(option);

                                        Swal.fire(
                                            'Registrado!',
                                            response + '.',
                                            'success'
                                        );
                                    }, error: function (xhr, status, error) {
                                        console.log(error);
                                    }
                                });
                            } else {
                                Swal.fire(
                                    'Imposible Registrar!',
                                    response + '.',
                                    'error'
                                );
                            }

                        },
                        error: function (xhr, status, error) {
                            console.log(error);
                        }
                    });
                }
            });
            document.querySelectorAll('.form-outline').forEach((formOutline) => {
                new mdb.Input(formOutline).init();
            });
        }

    </script>
</div>