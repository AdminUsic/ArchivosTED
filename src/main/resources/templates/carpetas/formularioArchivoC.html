<div class="container-fluid">
    <!-- /.card -->
    <!-- Horizontal Form -->
    <div class="card card-info">
        <div class="card-header">
            <h2 class="m-0 font-weight-bold card-title"
                th:text="${edit}? 'Modificar Registro de Archivo' : 'Registrar Archivo'"></h2>
        </div>
        <!-- /.card-header -->
        <!-- form start -->

        <form class="form-horizontal" id="FormularioRegistrarArchi" method="POST"
            th:action="${edit} ? @{/ModArchivoG} : @{/GuardarRegistroArchivo}" enctype="multipart/form-data">
            <div class="card-body">
                <div th:if="${edit == 'true'}">
                    <input type="hidden" th:field="${archivo.id_archivo}" />
                </div>
                <input type="hidden" th:each="carpeta : ${carp}" th:value="${carpeta}" id="id_carpeta"
                    name="id_carpeta" />
                <div class="row">
                    <div class="col-sm-6">
                        <div class="form-group form-outline">
                            <input type="number" th:field="${archivo.NroDocumental}" class="form-control"
                                placeholder="Introdusca el Nro. Documental" min="1" required />
                            <label class="form-label">Nro. Documental:</label>
                        </div>
                        <div class="form-group form-outline">
                            <input type="text" th:field="${archivo.nombre}" class="form-control"
                                placeholder="Introdusca un nombre/titulo" required />
                            <label class="form-label">Nombre:</label>
                        </div>
                        <div class="form-group form-outline">
                            <input type="text" th:field="${archivo.descripcion}" class="form-control"
                                placeholder="Descripción del Archivo" required />
                            <label class="form-label">Descripción:</label>
                        </div>
                        <div class="form-group form-outline">
                            <input type="text" th:field="${archivo.rutaFisica}" class="form-control"
                                placeholder="Introdusca una ruta fisica del Archivo" required />
                            <label class="form-label">Ruta del Archivo</label>
                        </div>
                        <div class="form-group">
                            <label>Seccion Documental</label>
                            <select class="select-fieldArchivoModalC" style="width: 100%;" th:field="${archivo.unidad}">
                                <option th:value="${edit} ? ${archivo.unidad.id_unidad} : ''"
                                    th:text="${archivo.unidad != null} ? ${archivo.unidad.nombre} : 'Seleccionar'"
                                    selecte></option>
                                <option th:each="unid: ${seccionesDocumental}" th:text="${unid.nombre}"
                                    th:value="${unid.id_unidad}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="form-group">
                            <label>Serie Documental</label>
                            <select class="select-fieldArchivoModalC" style="width: 100%;"
                                th:field="${archivo.serieDocumental}" id="selectSeccionDAC">
                                <option th:value="${edit} ? ${archivo.serieDocumental.id_serie} : ''"
                                    th:text="${edit} ? ${archivo.serieDocumental.nombre} : 'Seleccionar'" selected>
                                </option>
                                <option th:each="serieDoc: ${seriesDocumental}" th:text="${serieDoc.nombre}"
                                    th:value="${serieDoc.id_serie}"></option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tipoArchivo">Tipo de Archivo</label>
                            <select class="select-fieldArchivoModalC" style="width: 100%;"
                                th:field="${archivo.tipoArchivo}" id="selectTipoAC">
                                <option th:value="${edit} ? ${archivo.tipoArchivo.id_tipoArchivo} : ''"
                                    th:text="${archivo.tipoArchivo != null} ? ${archivo.tipoArchivo.nombre_tipo} : 'Seleccionar'"
                                    selected></option>
                                <option th:each="tiposA: ${TiposArchivos}" th:text="${tiposA.nombre_tipo}"
                                    th:value="${tiposA.id_tipoArchivo}"></option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tipoArchivo">Responsable de la Unidad Documental</label><br>
                            <div class="input-group" style="width: 100%;">
                                <select class="select-fieldArchivoModalC" style="width: 90%;"
                                    th:field="${archivo.persona}" id="selectResponsableAC">
                                    <option th:value="${edit} ? ${archivo.persona.id_persona} : ''"
                                        th:text="${archivo.persona != null} ? ${archivo.persona.nombre + ' ' + archivo.persona.apellido} : 'Seleccionar'"
                                        th:selected="${archivo.persona != null}"></option>
                                    <option th:each="persona: ${personas}"
                                        th:text="${persona.nombre}+' '+${persona.apellido}"
                                        th:value="${persona.id_persona}"></option>
                                </select>
                                <a class="btn btn-success" type="button" onclick="AgregarPersonaArchivo()">
                                    <i class="fas fa-user-plus"></i>
                                </a>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Fecha de Emision:</label>
                            <input type="text" class="form-control datepickerformArch" name="fechaEmision"
                                placeholder="Seleccione una fecha" id="fechaEmision" th:field="${archivo.fechaEmision}"
                                required />
                        </div>
                    </div>
                    <div th:class="${edit}? 'col-sm-6' : ''">
                        <div class="form-group">
                            <label class="form-label">Adjuntar Archivo</label>
                            <input type="file" name="PDF" id="PDFformularioModalC" accept=".pdf"
                                data-validation="required" th:required="${edit==null}">
                            <div id="alertasFormArchivoModalC"></div>
                        </div>
                    </div>
                    <div th:class="${edit}? 'col-sm-6' : ''" th:if="${edit == 'true'}">
                        <div class="form-group" th:if="${edit == 'true'}">
                            <div class="filtr-item col-sm-2">
                                <p class="text-muted m-0">Archivo:</p>
                                <div class="image-container">
                                    <a type="button" data-mdb-dismiss="modal" data-mdb-toggle="modal"
                                        data-mdb-target="#archivoModal"
                                        th:attr="onclick='ContenidoArchivo(\'' + ${archivo.id_archivo} + '\')'">
                                        <img class="icono-image" th:src="@{'/verIcoPdf/' + ${archivo.id_archivo}}"
                                            alt="Imagen 1">
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer" style="background-color: white;">
                    <button type="submit" class="btn btn-success"
                        th:text="${edit} ? 'Guardar Cambios' : 'Registrar'"></button>
                    <a type="button" onclick="cancelarModArchivo()" class="btn btn-default float-right">Cancelar</a>
                </div>
        </form>
    </div>

    <!-- /.card -->
    <script>
        $(document).ready(function () {
            $('#FormularioRegistrarArchi').submit(function (event) {
                event.preventDefault();
                var form = document.getElementById("FormularioRegistrarArchi");
                var id_carpeta = document.getElementById("id_carpeta").value;
                var action = form.action;
                var formData = new FormData(form);
                //formData.append("fechaEmision", fechaEmision);
                //alert("la action es: "+action);
                //var formData = $(this).serialize();

                var selectSeccionDAC = document.getElementById("selectSeccionDAC").value;
                var selectTipoAC = document.getElementById("selectTipoAC").value;
                var selectResponsableAC = document.getElementById("selectResponsableAC").value;

                if (selectSeccionDAC != "" && selectTipoAC != "" && selectResponsableAC != "") {
                    $.ajax({
                        type: 'POST',
                        url: $(this).attr('action'),
                        data: formData,
                        contentType: false,  // No establecer el tipo de contenido aquí
                        processData: false,  // No procesar los datos
                        //contentType: 'application/x-www-form-urlencoded', // Agregar esta línea
                        success: function (response) {
                            var mensaje = response;
                            if (response == "Se ha Registrado el Archivo correctamente") {
                                AbrirCarpeta(id_carpeta);
                                cargarRegistroIco();
                                toastr.success(mensaje);
                            } else if (mensaje == "Se ha Modificado el Archivo correctamente") {
                                AbrirCarpeta(id_carpeta);
                                cargarRegistroIco();
                                toastr.success(mensaje);
                            } else if (mensaje = "ERROR AL REGISTRAR ARCHIVO") {
                                toastr.error(mensaje);
                            } else if (mensaje = "ERROR MODIFICAR EL ARCHIVO") {
                                toastr.error(mensaje);
                            }
                            /*
                            if (action == "/ModArchivoG") {
                                AbrirCarpeta(id_carpeta);
                                var Toast = Swal.mixin({
                                    toast: true,
                                    position: 'top-end',
                                    showConfirmButton: false,
                                    timer: 3000
                                });
                                toastr.success('Los datos del Registro se han Modificado Correctamente');
                            } else {
                                AbrirCarpeta(id_carpeta);
                                cargarTabla();
                                var Toast = Swal.mixin({
                                    toast: true,
                                    position: 'top-end',
                                    showConfirmButton: false,
                                    timer: 3000
                                });
                                toastr.success('Los datos se han Registrado Correctamente');
                            }
                            var div = document.getElementById("dataTable");
                            div.scrollIntoView({ behavior: 'smooth' });*/
                        },
                        error: function (xhr, status, error) {
                            toastr.error('Ha ocurrido un error. Por favor, intenta nuevamente.');
                            console.error(error);
                            // Manejo de errores
                        }
                    });
                } else if (selectSeccionDAC == "") {
                    toastr.info('Tiene que seleccionar una Unidad/Seccion Documental para este Registro');
                } else if (selectTipoAC == "") {
                    toastr.info('Tiene que seleccionar un Tipo de Archivo para este Registro');
                } else if (selectResponsableAC == "") {
                    toastr.info('Tiene que seleccionar al Responsable de la Unidad Documental para este Registro');
                }

            });

        });
        function limpiarFormularioR() {
            var form = document.getElementById("FormularioRegistrarArchi");
            form.reset();
        }
        function cancelarModArchivo() {
            var id_carpeta = document.getElementById("id_carpeta").value;
            AbrirCarpeta(id_carpeta);
            cancelarMod();
        }
    </script>

    <script>
        var fileInput
        var nombreArchivo;
        // Agregamos un evento al input de tipo archivo para que se active cuando se seleccione un archivo
        document.getElementById("PDFformularioModalC").addEventListener("change", function () {
            // Obtenemos el elemento seleccionado
            fileInput = document.getElementById("PDFformularioModalC");
            nombreArchivo = fileInput.files[0].name;
            // Verificamos si se seleccionó un archivo
            if (fileInput.files.length > 0) {
                // Obtenemos el nombre del archivo
                var fileName = fileInput.files[0].name;
                // Verificamos si la extensión del archivo es PDF
                if (!isValidPDF(fileName)) {
                    // Reseteamos el valor del input file para borrar la selección inválida
                    fileInput.value = "";
                    $('#alertasFormArchivoModalC').html('<div class="alert alert-danger alert-dismissible">' +
                        '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
                        '<h6><i class="icon fas fa-ban"></i> El archivo no es Valido!</h6>' +
                        'Solo se Admite Archivos tipo PDF' +
                        '</div>');
                } else {

                    $('#alertasFormArchivoModalC').html('<div class="alert alert-success alert-dismissible">' +
                        '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
                        '<h6><i class="icon fas fa-check"></i> El archivo ' + nombreArchivo + ' es Valido!</h6>' +
                        '</div>');
                }
            }
        });

        // Función para validar si el nombre del archivo tiene extensión PDF
        function isValidPDF(fileName) {
            var validExtensions = ["pdf"];
            var fileExtension = fileName.split(".").pop().toLowerCase();
            return validExtensions.indexOf(fileExtension) !== -1;
        }

        $(function () {

            $('#PDFformularioModalC').bs_dropzone({
                maxFiles: 1,
                acceptedFiles: '.pdf',
                boxClass: 'alert p-5 text-center font-weight-bold',
                noneColorClass: 'alert alert-success alert-dismissible',
                dragColorClass: 'alert alert-warning alert-dismissible',
                doneColorClass: 'alert alert-success alert-dismissible',
                failColorClass: 'alert alert-danger alert-dismissible',
                language: {
                    emptyText: 'Introdusca o arrastre un archivo PDF',
                    dragText: '[Soltar aquí]',
                    dropText: 'El archivo se subió correctamente'
                }
            });

        });
    </script>
    <script>
        document.querySelectorAll('.form-outline').forEach((formOutline) => {
            new mdb.Input(formOutline).init();
        });
    </script>
    <script>
        $('.select-fieldArchivoModalC').select2({
            theme: 'bootstrap-5'
        });

        $('.select-fieldArchivoModalC1').select2({
            theme: 'bootstrap-5'
        });
    </script>

    <script>
        $(function () {
            $('input.datepickerformArch').datepicker({
                format: "DD/MM/YYYY",
                minDate: "1900-01-01"
            });
        });
    </script>

    <script>
        $(function () {
            bsCustomFileInput.init();
        });
    </script>
    <script>
        function AgregarPersonaArchivo() {
            Swal.fire({
                title: 'Agregar Responsable',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Agregar',
                html: '<br><div class="container-fluid">' +
                    '<form class="form-horizontal" id="FormAgregarPersonaArchivo" method="POST" action="/RegistrarPersonaA">' +
                    '<div class="form-group form-outline">' +
                    '<input type="text" name="nombrePerson" id="nombrePerson" class="form-control" placeholder="Introduzca Nombres" required/>' +
                    '<label class="form-label" for="nombre">Nombre</label>' +
                    '</div>' +
                    '<div class="form-group form-outline">' +
                    '<input type="text" name="apellidoPerson" id="apellidoPerson" class="form-control" placeholder="Introduzca Apellidos" required/>' +
                    '<label class="form-label">Apellidos</label>' +
                    '</div>' +
                    '<div class="form-group form-outline">' +
                    '<input type="number" name="ciPerson" class="form-control" placeholder="Introduzca C.I." required/>' +
                    '<label class="form-label">C.I.</label>' +
                    '</div>' +
                    '</form>' +
                    '</div>'
            }).then((result) => {
                if (result.isConfirmed) {
                    var formData = $('#FormAgregarPersonaArchivo').serialize();
                    $.ajax({
                        type: 'POST',
                        url: $('#FormAgregarPersonaArchivo').attr('action'),
                        data: formData,
                        contentType: 'application/x-www-form-urlencoded',
                        success: function (response) {
                            if (response == 'Se realizó el registro correctamente') {
                                $.ajax({
                                    type: 'POST',
                                    url: '/DatoPersona',
                                    data: formData,
                                    contentType: 'application/x-www-form-urlencoded',
                                    success: function (fila) {
                                        var select = document.getElementById('selectResponsableAC');
                                        var option = document.createElement('option');
                                        option.value = fila[0];
                                        option.text = fila[1];
                                        option.selected = true; 
                                        select.appendChild(option);

                                        Swal.fire(
                                            'Registrado!',
                                            response + '.',
                                            'success'
                                        );
                                    }, error: function (xhr, status, error) {
                                        console.log(error);
                                    }
                                });
                            } else {
                                Swal.fire(
                                    'Imposible Registrar!',
                                    response + '.',
                                    'error'
                                );
                            }

                        },
                        error: function (xhr, status, error) {
                            console.log(error);
                        }
                    });
                }
            });
            document.querySelectorAll('.form-outline').forEach((formOutline) => {
                new mdb.Input(formOutline).init();
            });
        }

    </script>
</div>